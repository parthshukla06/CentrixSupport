<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Get Help - CentrixSupport</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .text-shadow {
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    /* Typing loader animation */
    .typing-loader {
      width: 30px;
      display: flex;
      justify-content: space-between;
    }
    .typing-loader span {
      width: 6px;
      height: 6px;
      background-color: #0f766e;
      border-radius: 50%;
      animation: typing 1s infinite;
    }
    .typing-loader span:nth-child(2) { animation-delay: 0.2s; }
    .typing-loader span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    /* Fade in animation for new messages */
    .animate-fade-in {
      animation: fadeIn 0.3s ease-in-out; 
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Sidebar layout */
    #chatMain.with-sidebar {
      margin-left: 16rem;
    }

    /* ====== Message Styles ====== */
    .bot-message, .user-message {
      padding: 10px 12px;
      border-radius: 12px;
      margin: 8px 0;
      max-width: 70%;
      word-wrap: break-word;
      font-size: 15px;
      line-height: 1.4;
    }

    .bot-message {
      background: #a0f5e2;
      color: #064e3b;
    }

    .user-message {
      background: #0f766e;
      color: white;
      margin-left: auto;
    }

    /* ====== Footer (time + icons) ====== */
    .message-footer {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 12px;
      color: gray;
    }

    .timestamp {
      font-style: italic;
    }

    /* Action buttons üìã üîä */
    .icon-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      color: #0f766e;
      transition: 0.2s;
    }

    .icon-btn:hover {
      color: #064e3b;
      transform: scale(1.1);
    }

  </style>
</head>
<body class="bg-teal-100 font-sans min-h-screen overflow-x-hidden relative">

  <!-- Sidebar -->
  <div id="historySidebar" class="bg-teal-800 text-white w-64 p-4 space-y-2 hidden fixed inset-y-0 left-0 z-30 overflow-y-auto max-h-screen transition-transform">
    <h2 class="text-xl font-semibold mb-4">Chat History</h2>
    <div id="historyList" class="space-y-2"></div>
  </div>

  <!-- Main Layout -->
  <div id="mainLayout" class="transition-all">

    <!-- Navbar -->
    <nav class="bg-teal-800 text-white px-4 md:px-8 py-4 flex justify-between items-center fixed w-full z-40 top-0">
      <div class="flex items-center gap-4">
        <button id="toggleHistory" class="bg-white text-teal-900 px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-teal-500">‚ò∞</button>
        <div class="flex items-center gap-2">
          <img src="{{ url_for('static', filename='img/centic.png') }}" alt="Centrix Logo" class="h-10 w-10 rounded-full shadow-sm" />
          <div class="text-xl font-bold">CentrixSupport</div>
        </div>
      </div>
      <div class="hidden md:flex flex-wrap items-center gap-4 text-sm font-medium text-white">
        <a href="{{ url_for('home') }}" class="hover:underline">Home</a>
        <a href="{{ url_for('about') }}" class="hover:underline">About</a>
        <a href="{{ url_for('resource') }}" class="hover:underline">Resources</a>
        <a href="{{ url_for('contact') }}" class="hover:underline">Contact</a>
        <a href="{{ url_for('help') }}" class="hover:underline">Get Help</a>
      </div>
      <button id="newChat" class="ml-4 bg-white text-teal-900 px-3 py-1 rounded hover:bg-gray-100 text-sm">+ New Chat</button>
    </nav>

    <!-- Chat Area -->
    <main id="chatMain" class="px-4 md:px-24 py-6 mt-16 flex-1 overflow-auto transition-all">
      <h1 class="text-3xl font-bold text-teal-900 text-center mb-4">Talk to Centrix Bot</h1>

      <!-- File Upload -->
      <form id="uploadForm" class="mb-4 flex flex-col md:flex-row md:items-center gap-4">
        <input type="file" id="fileInput" class="bg-white px-4 py-2 rounded border border-teal-300" multiple />
        <button type="submit" class="bg-teal-700 text-white px-4 py-2 rounded hover:bg-teal-600">Upload File</button>
        <div class="w-full md:w-1/2" id="uploadStatus"></div>
        <ul id="fileList" class="mt-2 space-y-1 text-sm text-gray-800"></ul> 
      </form>

      <!-- Chat Box -->
      <div id="chatBox" class="bg-white rounded-xl shadow-inner p-4 space-y-4 h-96 overflow-y-auto">
        <!-- Bot message example -->
        <div class="text-left">
          <div class="inline-block bg-teal-200 text-teal-900 px-4 py-2 rounded-xl text-shadow animate-fade-in">
            <p>Hi there! How can I support you today?</p>
            <div class="message-footer">
              <span class="timestamp">09:52 AM</span>
              <button class="icon-btn" onclick="copyMessage(this)">üìã</button>
              <button class="icon-btn" onclick="speakMessage(this)">üîä</button>
            </div>
          </div>
        </div>

        <!-- User message example -->
        <div class="text-right">
          <div class="inline-block bg-teal-700 text-white px-4 py-2 rounded-xl animate-fade-in">
            <p>Hello!</p>
            <div class="message-footer">
              <span class="timestamp">09:52 AM</span>
              <button class="icon-btn" onclick="copyMessage(this)">üìã</button>
              <button class="icon-btn" onclick="speakMessage(this)">üîä</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input -->
      <form id="chatForm" class="mt-6 flex gap-4 items-center">
        <input type="text" id="userInput" 
          class="flex-1 px-4 py-2 border-2 border-teal-500 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent placeholder-gray-400" 
          placeholder="Ask me anything..." autocomplete="off" />
        
        <!-- Mic / Stop Button -->

        <button type="button" id="micBtn" 
          class="bg-teal-700 text-white p-2 rounded-md hover:bg-green-400 transition flex items-center justify-center">
          <img id="micIcon" width="24" height="24" 
            src="https://img.icons8.com/material-sharp/24/microphone--v1.png" 
            alt="mic"/>
        </button>
        
        <!-- üöÄ Send Button -->
        <button type="submit" 
          class="bg-teal-700 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition">Send üöÄ</button>
      </form>
    </main>
  </div>

  <!-- To-Do Modal -->
  <div id="todoModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-teal-800">üìù To-Do List</h2>
        <button onclick="toggleTodoModal()" class="text-teal-700 font-bold">‚úñ</button>
      </div>
      <input id="taskInput" type="text" placeholder="Enter a task..." class="w-full px-3 py-2 mb-2 border rounded border-teal-300"/>
      <div class="flex justify-between mb-4">
        <button onclick="addTask()" class="bg-teal-600 text-white px-3 py-1 rounded hover:bg-teal-700 text-sm">Add</button>
        <button onclick="removeLastTask()" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 text-sm">Remove Last</button>
        <button onclick="clearTasks()" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm">Clear</button>
      </div>
      <ul id="taskList" class="list-disc list-inside text-teal-800 space-y-1 max-h-40 overflow-y-auto"></ul>
    </div>
  </div>
</body>


  <script>
    // ===== DOM =====
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const uploadStatus = document.getElementById("uploadStatus");
    const fileList = document.getElementById("fileList");
    const historyList = document.getElementById("historyList");
    const micBtn = document.getElementById("micBtn"); // üé§ Mic button

    // ===== State =====
    let uploadedFilePaths = [];
    let fileUsedOnce = false;
    let pendingSearchAbort = null;
    let isSearching = false;
    let currentSessionId = localStorage.getItem("currentSessionId") || Date.now().toString();
    let sessions = JSON.parse(localStorage.getItem("chatSessions") || "{}");

    // ===== Audio =====
    const sendSound = new Audio("/static/sounds/send.mp3");
    const receiveSound = new Audio("/static/sounds/receive.mp3");

    // ===== Speech Synthesis =====
    let currentUtterance = null;
    let isSpeaking = false;
    let femaleVoice = null;
    let currentSpeakBtn = null;

    function waitForVoices(timeoutMs = 2000) {
      return new Promise((resolve) => {
        const start = performance.now();
        const check = () => {
          const voices = window.speechSynthesis.getVoices();
          if (voices && voices.length) return resolve(voices);
          if (performance.now() - start > timeoutMs) return resolve(voices || []);
          setTimeout(check, 50);
        };
        check();
      });
    }
    function pickFemaleVoice(voices) {
      const byName = (s) => s ? s.toLowerCase() : "";
      const candidates = voices.filter(v =>
        byName(v.name).includes("female") ||
        byName(v.name).includes("woman") ||
        (v.lang && v.lang.toLowerCase().startsWith("en") && byName(v.name).includes("google"))
      );
      if (candidates.length) return candidates[0];
      const en = voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en"));
      return en || voices[0] || null;
    }
    async function initVoices() {
      const voices = await waitForVoices();
      femaleVoice = pickFemaleVoice(voices);
    }
    window.speechSynthesis.onvoiceschanged = () => initVoices();
    initVoices();

    function resetSpeakUI() {
      isSpeaking = false;
      if (currentSpeakBtn) currentSpeakBtn.innerHTML = "üîä";
      currentSpeakBtn = null;
      currentUtterance = null;
    }
    function stopAllSpeech() {
      try { window.speechSynthesis.cancel(); } catch {}
      resetSpeakUI();
    }
    function toggleSpeech(text, btn) {
      if (isSpeaking) { stopAllSpeech(); return; }
      stopAllSpeech();
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.voice = femaleVoice || null;
      currentUtterance.pitch = 1.1;
      currentUtterance.rate = 1;
      currentUtterance.onend = resetSpeakUI;
      currentUtterance.onerror = resetSpeakUI;
      try {
        window.speechSynthesis.speak(currentUtterance);
        isSpeaking = true;
        currentSpeakBtn = btn || null;
        if (currentSpeakBtn) currentSpeakBtn.innerHTML = "‚èπÔ∏è";
      } catch { resetSpeakUI(); }
    }
    window.addEventListener("beforeunload", stopAllSpeech);

    // ===== Utils =====
    function addTimestamp() {
      return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }
    function saveMessage(sessionId, role, text) {
      if (!sessions[sessionId]) sessions[sessionId] = { messages: [] };
      sessions[sessionId].messages.push({ role, text, time: addTimestamp() });
      localStorage.setItem("chatSessions", JSON.stringify(sessions));
      localStorage.setItem("currentSessionId", sessionId);
      renderHistory();
    }
    function renderHistory() {
      historyList.innerHTML = "";
      Object.entries(sessions).forEach(([sessionId, session]) => {
        const container = document.createElement("div");
        container.className = "relative group";
        const firstMessage = session.messages.find(m => m.role === "user");
        const label = firstMessage ? `${firstMessage.text.slice(0, 20)}...` : "Untitled";
        const div = document.createElement("div");
        div.className = "text-sm bg-teal-700 p-2 rounded hover:bg-teal-600 cursor-pointer pr-8";
        const startedAt = session.messages[0]?.time || "time";
        div.textContent = `${label} [${startedAt}]`;
        div.onclick = () => loadSession(sessionId);
        const delBtn = document.createElement("button");
        delBtn.innerHTML = `<img src="https://img.icons8.com/pulsar-gradient/48/clear-symbol.png" width="20">`;
        delBtn.className = "absolute right-2 top-1/2 transform -translate-y-1/2 opacity-0 group-hover:opacity-100";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          delete sessions[sessionId];
          localStorage.setItem("chatSessions", JSON.stringify(sessions));
          if (currentSessionId === sessionId) {
            currentSessionId = Object.keys(sessions)[0] || Date.now().toString();
            localStorage.setItem("currentSessionId", currentSessionId);
            loadSession(currentSessionId);
          }
          renderHistory();
        };
        container.appendChild(div);
        container.appendChild(delBtn);
        historyList.appendChild(container);
      });
    }
    function loadSession(sessionId) {
      currentSessionId = sessionId;
      localStorage.setItem("currentSessionId", sessionId);
      chatBox.innerHTML = "";
      const session = sessions[sessionId];
      if (session?.messages) {
        session.messages.forEach(msg => addMessage(msg.text, msg.role === "user", msg.time));
      }
    }
    function addMessage(text, isUser = false, time = null) {
      const wrapper = document.createElement("div");
      wrapper.className = isUser ? "text-right" : "text-left";
      const bubble = document.createElement("div");
      bubble.className = `inline-block relative group ${isUser ? "bg-teal-600 text-white" : "bg-teal-200 text-teal-900 animate-fade-in"} px-4 py-2 rounded-xl whitespace-pre-wrap`;
      const safe = (txt) => String(txt).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      bubble.innerHTML = `${safe(text).replace(/\n/g, "<br>")}`;
      const actionRow = document.createElement("div");
      actionRow.className = "flex items-center gap-2 mt-1 text-xs text-gray-500";
      const timestamp = document.createElement("span");
      timestamp.textContent = `[${time || addTimestamp()}]`;
      const copyBtn = document.createElement("button");
      copyBtn.className = "hover:text-teal-700";
      copyBtn.innerHTML = "üìã";
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(text).then(() => {
          copyBtn.innerHTML = "‚úÖ"; setTimeout(() => (copyBtn.innerHTML = "üìã"), 1000);
        });
      };
      const speakBtn = document.createElement("button");
      speakBtn.className = "hover:text-teal-700";
      speakBtn.innerHTML = "üîä";
      speakBtn.onclick = () => toggleSpeech(text, speakBtn);
      actionRow.appendChild(timestamp);
      actionRow.appendChild(copyBtn);
      actionRow.appendChild(speakBtn);
      bubble.appendChild(actionRow);
      wrapper.appendChild(bubble);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
      if (isUser) sendSound.play().catch(()=>{}); else receiveSound.play().catch(()=>{});
    }
    function addTypingBubble() {
      const wrapper = document.createElement("div");
      wrapper.className = "text-left";
      const bubble = document.createElement("div");
      bubble.className = "inline-block bg-teal-200 text-teal-900 px-4 py-2 rounded-xl whitespace-pre-wrap animate-fade-in";
      const loading = document.createElement("div");
      loading.className = "typing-loader mt-1";
      loading.innerHTML = "<span></span><span></span><span></span>";
      bubble.appendChild(loading);
      wrapper.appendChild(bubble);
      chatBox.appendChild(wrapper);
      chatBox.scrollTop = chatBox.scrollHeight;
      return { bubble, loading };
    }
    function markFilesConsumed() {
      fileUsedOnce = true;
      uploadedFilePaths = [];
      fileInput.value = "";
      uploadStatus.innerHTML = `<p class='text-sm text-yellow-800'>üîÅ Files used. Upload again if needed.</p>`;
      fileList.innerHTML = "";
    }

    // ===== New chat =====
    document.getElementById("newChat").addEventListener("click", () => {
      currentSessionId = Date.now().toString();
      sessions[currentSessionId] = { messages: [] };
      localStorage.setItem("chatSessions", JSON.stringify(sessions));
      localStorage.setItem("currentSessionId", currentSessionId);
      chatBox.innerHTML = "";
      addMessage("Hi there! How can I support you today?");
      renderHistory();
    });

    // ===== Upload handler =====
    uploadForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const files = fileInput.files;
      if (!files.length) return alert("Please select or drop a file.");
      uploadStatus.innerHTML = "";
      fileUsedOnce = false;
      uploadedFilePaths = [];
      const formData = new FormData();
      for (const f of files) formData.append("file", f);
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/upload", true);
      chatForm.querySelector("button").disabled = true;
      userInput.disabled = true;
      const progressBar = document.createElement("div");
      progressBar.className = "bg-teal-600 h-2.5 rounded-full w-0 mb-1 transition-all duration-500";
      const container = document.createElement("div");
      container.className = "w-full bg-gray-200 rounded-full mt-2";
      container.appendChild(progressBar);
      uploadStatus.appendChild(container);
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = percent + "%";
        }
      };
      xhr.onload = function () {
        chatForm.querySelector("button").disabled = false;
        userInput.disabled = false;
        if (xhr.status === 200) {
          let result = {};
          try { result = JSON.parse(xhr.responseText || "{}"); } catch {}
          uploadedFilePaths = result.filepaths || [];
          if (uploadedFilePaths.length) {
            uploadStatus.innerHTML = `<p class='text-sm text-green-700 mt-2'>‚úÖ Files uploaded successfully.</p><p class='text-sm text-gray-700'>üí¨ Your <strong>next question</strong> will use them.</p>`;
            fileList.innerHTML = uploadedFilePaths.map(p => {
              const name = p.split(/[\\/]/).pop();
              return `<div class="text-sm text-teal-800 mt-1">üìé ${name}</div>`;
            }).join("");
          } else {
            uploadStatus.innerHTML = `<p class='text-sm text-red-700'>‚ùå Upload succeeded but no file paths returned.</p>`;
          }
        } else uploadStatus.innerHTML = "<p class='text-sm text-red-700'>‚ùå Upload failed.</p>";
      };
      xhr.onerror = () => {
        chatForm.querySelector("button").disabled = false;
        userInput.disabled = false;
        uploadStatus.innerHTML = "<p class='text-sm text-red-700'>‚ùå Network error during upload.</p>";
      };
      xhr.send(formData);
    });

    // ===== Chat submit (RAG flow intact) =====
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (isSearching) return;
      const query = userInput.value.trim();
      if (!query) return;
      addMessage(query, true);
      saveMessage(currentSessionId, "user", query);
      userInput.value = "";
      const { bubble, loading } = addTypingBubble();
      const shouldAttachFiles = uploadedFilePaths.length && !fileUsedOnce;
      const payload = { query, filepaths: shouldAttachFiles ? uploadedFilePaths : [], session_name: currentSessionId };
      try { pendingSearchAbort?.abort(); } catch {}
      pendingSearchAbort = new AbortController();
      isSearching = true;
      try {
        const res = await fetch("/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: pendingSearchAbort.signal
        });
        if (!res.ok) throw new Error(`Server error (${res.status})`);
        const data = await res.json();
        const responseText = (data.response || "").trim() || "‚ö†Ô∏è No response.";
        if (bubble.contains(loading)) bubble.removeChild(loading);
        const responseEl = document.createElement("p");
        responseEl.className = "whitespace-pre-wrap animate-fade-in";
        responseEl.innerHTML = responseText.replace(/\n/g, "<br>");
        bubble.appendChild(responseEl);
        // action row
        const actionRow = document.createElement("div");
        actionRow.className = "flex items-center gap-2 mt-1 text-xs text-gray-500";
        const timestamp = document.createElement("span");
        timestamp.textContent = `[${addTimestamp()}]`;
        const copyBtn = document.createElement("button");
        copyBtn.className = "hover:text-teal-700";
        copyBtn.innerHTML = "üìã";
        copyBtn.onclick = () => navigator.clipboard.writeText(responseText);
        const speakBtn = document.createElement("button");
        speakBtn.className = "hover:text-teal-700";
        speakBtn.innerHTML = "üîä";
        speakBtn.onclick = () => toggleSpeech(responseText, speakBtn);
        actionRow.appendChild(timestamp);
        actionRow.appendChild(copyBtn);
        actionRow.appendChild(speakBtn);
        bubble.appendChild(actionRow);
        saveMessage(currentSessionId, "bot", responseText);
        if (shouldAttachFiles) markFilesConsumed();
      } catch (err) {
        if (bubble.contains(loading)) bubble.removeChild(loading);
        bubble.innerHTML = `‚ùå Failed to get response from server.<br><small>${err.message}</small>`;
        console.error("‚ùå Chat error:", err);
      } finally {
        isSearching = false;
      }
    });

    // ===== On load =====
    window.addEventListener("DOMContentLoaded", () => {
      const seenDisclaimer = localStorage.getItem("seenDisclaimer");
      if (!seenDisclaimer) {
        localStorage.setItem("seenDisclaimer", "yes");
        window.location.href = "/disclaimer"; return;
      }
      renderHistory();
      if (!sessions[currentSessionId]) {
        sessions[currentSessionId] = { messages: [] };
        localStorage.setItem("chatSessions", JSON.stringify(sessions));
      }
      loadSession(currentSessionId);
    });

    // ===== Sidebar toggle =====
    const historySidebar = document.getElementById("historySidebar");
    const toggleHistory = document.getElementById("toggleHistory");

    toggleHistory.addEventListener("click", () => {
      if (historySidebar.classList.contains("hidden")) {
        historySidebar.classList.remove("hidden");
        document.getElementById("chatMain").classList.add("with-sidebar");
      } else {
        historySidebar.classList.add("hidden");
        document.getElementById("chatMain").classList.remove("with-sidebar");
      }
    });

        // ===== Speech Recognition (Voice to Text) =====
        let recognition;
    if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = "en-US";   
      recognition.continuous = false;
      recognition.interimResults = false;

      const micBtn = document.getElementById("micBtn");
      const micIcon = document.getElementById("micIcon");
      let isListening = false;

      micBtn.addEventListener("click", () => {
        if (!isListening) {
          recognition.start();
          micIcon.src = "https://img.icons8.com/fluency/24/stop-squared.png"; // stop icon (24x24)
          micIcon.width = 24;
          micIcon.height = 24;
          isListening = true;
        } else {
          recognition.stop();
          micIcon.src = "https://img.icons8.com/material-sharp/24/microphone--v1.png"; // mic icon
          micIcon.width = 24;
          micIcon.height = 24;
          isListening = false;
        }
      });

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById("userInput").value = transcript;
      };

      recognition.onend = () => {
        micIcon.src = "https://img.icons8.com/material-sharp/24/microphone--v1.png"; // reset to mic
        micIcon.width = 24;
        micIcon.height = 24;
        isListening = false;
      };

    } else {
      console.warn("Speech Recognition not supported in this browser.");
      document.getElementById("micBtn").style.display = "none";
    }


  </script>


</body>
</html>
